---
title: "School Profile Narrative"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    theme: paper
    highlight: tango
params:
  school_name: "School Name Placeholder"
  df_basic: NA
  df_enrol: NA
  df_teachers: NA
  df_infra: NA
  df_spec: NA
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(knitr)
library(dplyr)

# --- Helper: Get Value safely ---
get_val <- function(df, key) {
  if (is.null(df) || !is.data.frame(df) || nrow(df) == 0) return(NULL)
  val <- df$Value[df$Metric == key]
  if (length(val) == 0) return(NULL)
  return(val)
}

# --- Helper: Generate List Text ---
generate_list_text <- function(df, exclude_keys = c()) {
  if (is.null(df) || nrow(df) == 0) return("")
  leftover <- df %>% filter(!Metric %in% exclude_keys)
  if (nrow(leftover) == 0) return("")
  
  # Plain text format: "Metric: Value"
  text_parts <- paste0(leftover$Metric, ": ", leftover$Value)
  return(paste(text_parts, collapse = "; "))
}
```



# `r params$school_name`

**Data generated by STRIDE System**


1. Basic Information & Location
```{r}                                
df <- params$df_basic

if (!is.null(df) && nrow(df) > 0) {
  id <- get_val(df, "School ID")
  head_name <- get_val(df, "School Head")
  pos <- get_val(df, "Position")
  type <- get_val(df, "Typology")
  coc <- get_val(df, "Curricular Offering")
  
  # Plain text construction
  txt <- paste0(params$school_name)
  if (!is.null(id)) txt <- paste0(txt, " (School ID: ", id, ")")
  
  txt <- paste0(txt, " is currently categorized as a ")
  if (!is.null(type)) txt <- paste0(txt, type, " school") else txt <- paste0(txt, "school")
  
  if (!is.null(coc)) txt <- paste0(txt, " offering ", coc, ".") else txt <- paste0(txt, ".")
  
  if (!is.null(head_name)) {
    txt <- paste0(txt, " The school is currently managed by ", head_name)
    if (!is.null(pos)) txt <- paste0(txt, " (", pos, ").") else txt <- paste0(txt, ".")
  }
  
  mun <- get_val(df, "Municipality")
  brgy <- get_val(df, "Barangay")
  div <- get_val(df, "Division")
  
  if (!is.null(mun)) {
    txt <- paste0(txt, " It is strategically located in ")
    if (!is.null(brgy)) txt <- paste0(txt, "Barangay ", brgy, ", ")
    txt <- paste0(txt, mun)
    if (!is.null(div)) txt <- paste0(txt, " under the Division of ", div, ".") else txt <- paste0(txt, ".")
  }
  
  cat(paste0(txt, "\n\n"))
  
} else {
  cat("*No basic profile data available.*\n\n")
}
```



2. Enrolment Profile
```{r}
df <- params$df_enrol

if (!is.null(df) && nrow(df) > 0) {
  total <- get_val(df, "Total Enrolment")
  
  txt <- ""
  if (!is.null(total)) {
    txt <- paste0("The school has a total recorded student population of ", total, " learners. ")
  } else {
    txt <- "Enrolment breakdown is as follows: "
  }
  
  breakdown <- generate_list_text(df, exclude_keys = c("Total Enrolment"))
  
  if (breakdown != "") {
    txt <- paste0(txt, "The distribution across grade levels is: ", breakdown, ".")
  }
  
  cat(paste0(txt, "\n\n"))
} else {
  cat("*No enrolment records found.*\n\n")
}
```


3. Teacher Inventory & Needs
```{r}
df <- params$df_teachers

if (!is.null(df) && nrow(df) > 0) {
  total_t <- get_val(df, "Total Teachers")
  
  txt <- ""
  if (!is.null(total_t)) {
    txt <- paste0("The institution is supported by a teaching force of ", total_t, " personnel. ")
  }
  
  breakdown <- generate_list_text(df, exclude_keys = c("Total Teachers"))
  
  if (breakdown != "") {
    txt <- paste0(txt, "Current faculty analysis indicates: ", breakdown, ".")
  }
  
  cat(paste0(txt, "\n\n"))
} else {
  cat("*No teaching personnel data recorded.*\n\n")
}
```



4. Infrastructure & Facilities
```{r}
df <- params$df_infra

if (!is.null(df) && nrow(df) > 0) {
  classrooms <- get_val(df, "Total Classrooms")
  buildings <- get_val(df, "Total Buildings")
  shortage <- get_val(df, "Estimated Shortage")
  
  txt <- "Regarding physical facilities, the school inventory reports "
  
  if (!is.null(classrooms)) txt <- paste0(txt, classrooms, " instructional rooms ")
  if (!is.null(buildings)) txt <- paste0(txt, "housed within ", buildings, " buildings. ")
  
  if (!is.null(shortage)) {
    if (as.numeric(shortage) > 0) {
      txt <- paste0(txt, "Current analysis suggests a shortage of ", shortage, " classrooms based on standard parameters. ")
    } else {
      txt <- paste0(txt, "There is currently no estimated classroom shortage. ")
    }
  }
  
  details <- generate_list_text(df, exclude_keys = c("Total Classrooms", "Total Buildings", "Estimated Shortage"))
  
  if (details != "") {
    txt <- paste0(txt, "\n\nAdditional facility status: ", details, ".")
  }
  
  cat(paste0(txt, "\n\n"))
} else {
  cat("*No infrastructure data recorded.*\n\n")
}
```


5. Specialization Data (JHS/SHS)
```{r}
df <- params$df_spec

if (!is.null(df) && nrow(df) > 0) {
  cat("The distribution of teachers by area of specialization is as follows:\n\n")
  cat(paste0(generate_list_text(df), "\n\n"))
} else {
  cat("*No specialization data available (or not applicable for this school level).*\n\n")
}
```
<div class="footer"> <p>Note: Fields with values of '0', 'N/A', or blank have been excluded from this summary.


Generated by <strong>STRIDE</strong></p> </div>